<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TD d'introduction aux modèles de durée avec <code>Python</code></title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Roland Donat" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="https://roland-donat.github.io/ubs/Charte_graphique/IUT/ubs_iut_vannes.css" />
<link rel="stylesheet" type="text/css" href="https://roland-donat.github.io/ubs-lpsdm-qualite-donnees/custom.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">TD d'introduction aux modèles de durée avec <code>Python</code></h1>
<div id="table-of-contents">
<h2>Table des matières</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org40bbfc3">1. Objectifs</a></li>
<li><a href="#org35527ec">2. Environnement de travail</a></li>
<li><a href="#org49cef65">3. Introduction sur les modèles de durée</a></li>
<li><a href="#org890eaba">4. Données et objectif</a></li>
<li><a href="#org3eef6a2">5. Analyses descriptives</a>
<ul>
<li><a href="#org2ffdd7a">5.1. Analyses univariées</a></li>
<li><a href="#orgf786494">5.2. Analyses bivariées</a></li>
</ul>
</li>
<li><a href="#org11c3569">6. Définition de la notion de durée</a></li>
<li><a href="#org426e1bc">7. Modélisation non paramétrique</a>
<ul>
<li><a href="#org1cb3107">7.1. Fonction de répartition empirique (Kaplan-Meier)</a></li>
<li><a href="#org34a9868">7.2. Fonction de survie/fiabilité</a></li>
<li><a href="#orgcabc59f">7.3. Taux de risque instantané</a></li>
</ul>
</li>
<li><a href="#org6b0cea4">8. Modèle de Cox</a>
<ul>
<li><a href="#orgc6494e7">8.1. Éléments de théorie</a></li>
<li><a href="#org5f52b8a">8.2. Covariable quantitative</a></li>
<li><a href="#orge31a4a8">8.3. Covariable qualitative</a></li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-org40bbfc3" class="outline-2">
<h2 id="org40bbfc3"><span class="section-number-2">1</span> Objectifs</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>Découvrir le principe des modèles de durée.</li>
<li>Savoir identifier les données adaptées à une analyse par modèles de durée.</li>
<li>Comprendre quelques bases théoriques sur les modèles de durée.</li>
<li>Présenter la librairie <code>Python</code> <code>lifelines</code> permettant de mettre en oeuvre des modèles de durée.</li>
</ol>
</div>
</div>

<div id="outline-container-org35527ec" class="outline-2">
<h2 id="org35527ec"><span class="section-number-2">2</span> Environnement de travail</h2>
<div class="outline-text-2" id="text-2">
<p>
Dans cette session, nous allons travailler sur <a href="https://deepnote.com/">Deepnote</a> qui une plateforme de
développement collaborative en ligne reposant sur l'édition de <i>notebooks</i> (exactement comme
<a href="https://colab.research.google.com/">Google Colab</a>).
</p>

<p>
Avant de débuter le travail, veuillez à :
</p>
<ul class="org-ul">
<li>vous inscrire sur <a href="https://deepnote.com/">Deepnote</a> (si ce n'est pas déjà fait);</li>
<li>créer un nouveau <i>notebook</i> que vous dédierez à cette séance.</li>
</ul>
</div>
</div>

<div id="outline-container-org49cef65" class="outline-2">
<h2 id="org49cef65"><span class="section-number-2">3</span> Introduction sur les modèles de durée</h2>
<div class="outline-text-2" id="text-3">
<p>
Dans ce TD, nous nous intéressons à l'analyse statistique de données portant sur les temps d'occurrence d'un
événement d'intérêt. Il pourrait s'agir par exemple de données sur :
</p>
<ul class="org-ul">
<li>la durée de vie d'un patient atteint d'une maladie ;</li>
<li>la durée d'un composant électronique avant une panne, on parle dans ce cas de fiabilité ;</li>
<li>la quantité de chocolat avalée avant une indigestion ;</li>
<li>le nombre de clics sur un site avant la réalisation d'une action particulière (e.g. un achat).</li>
</ul>

<p>
Le point commun de ces données provient de leur nature. En effet, ces données (durée, quantité,
nombre) sont quantitatives et prennent des valeurs positives ou nulles. On pourrait généraliser en remarquant qu'elles sont définies sur un espace borné à gauche et infini à droite.  
</p>

<p>
Les statisticien-nes ont développé des modèles spécifiques permettant de tenir compte de cette
caractéristique particulière afin d'expliquer et prévoir l'occurrence des événements
sous-jacents. On parle ainsi de modèles de durée. Notons que les modèles de survie et les
modèles de fiabilité (tous deux équivalents) sont inclus dans la famille plus général des
modèles de durée. 
</p>

<p>
Les applications des modèles de durée sont très nombreuses. En reprenant les exemples précédents,
nous pourrions :
</p>
<ul class="org-ul">
<li>étudier l'efficacité d'un traitement sur la durée de vie de patients atteints d'une maladie ;</li>
<li>élaborer des stratégies de maintenance préventive pour des systèmes industriels ;</li>
<li>calculer la quantité de chocolat que l'on souhaite manger en fonction d'un risque d'indigestion
assumé ;</li>
<li>améliorer le parcours utilisateur sur un site web afin de maximiser la probabilité d'achat.</li>
</ul>

<p>
Dans ce TD, nous allons explorer brièvement le monde des modèles de durée en travaillant sur des données de
fiabilité issues d'un parc de distributeurs de tickets.
</p>
</div>
</div>

<div id="outline-container-org890eaba" class="outline-2">
<h2 id="org890eaba"><span class="section-number-2">4</span> Données et objectif</h2>
<div class="outline-text-2" id="text-4">
<p>
Les données utilisées dans ce TD contiennent un historique de durées et de sollicitations avant
défaillance majeure pour différents distributeurs de tickets. Chaque ligne représente l'occurrence
d'une défaillance majeure caractérisée par les informations suivantes :
</p>
<ul class="org-ul">
<li><code>model</code> : Marque de l'appareil codée par la chaîne <code>M + &lt;nombre entier&gt;</code>.</li>
<li><code>site</code> : Localisation du distributeur. Valeurs possibles : <code>E</code>, <code>S</code>, <code>I</code>, <code>H</code>.</li>
<li><code>component</code> : Composant siège de la défaillance majeure. Valeurs possibles : <code>C01</code>, <code>C02</code>.</li>
<li><code>nb_deg</code> : Nombre de pannes mineurs sur le distributeur entre deux pannes majeures du composant.</li>
<li><code>nb_pm</code> : Nombre de maintenances préventives effectué sur le distributeur entre deux pannes du composant.</li>
<li><code>ttf</code> : <i>Time To Failure</i>, temps (en heures) entre deux défaillances majeures du composant.</li>
<li><code>ctf</code> : <i>Cycle To Failue</i>, sollicitations du distributeur entre deux défaillances majeures du composant. Une sollicitation
est définie comme une opération effectuée sur le distributeur (e.g. un retrait, consultation des comptes, etc.).</li>
</ul>

<p>
L'objectif de ce TD est d'étudier la durée de vie des composants <code>C01</code> et <code>C02</code> des
distributeurs. D'un point de vue statistique, il s'agit d'étudier les variables <code>ttf</code> et <code>ctf</code> en
fonction des caractéristiques des distributeurs.
</p>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Charger les données dans votre notebook. Les données sont accessibles à l'adresse suivante : <a href="https://roland-donat.github.io/ubs-lpsdm-qualite-donnees/2021-2022/modeles_duree/data.csv">https://roland-donat.github.io/ubs-lpsdm-qualite-donnees/2021-2022/modeles_duree/data.csv</a>.</li>
<li>Identifier les données qualitatives et quantitatives, puis convertir les données qualitatives en <code>category</code>.</li>
</ol>
</div>
</div>


<div id="outline-container-org3eef6a2" class="outline-2">
<h2 id="org3eef6a2"><span class="section-number-2">5</span> Analyses descriptives</h2>
<div class="outline-text-2" id="text-5">
<p>
Il s'agit ici de mieux comprendre les variations des variables <code>ttf</code> et <code>ctf</code> caractérisant la durée de vie
des composants étudiés. Pour ce faire, nous allons effectuer des analyses graphiques univariées et
bivariées avec la librairie <code>plotly.express</code>.
</p>
</div>

<div id="outline-container-org2ffdd7a" class="outline-3">
<h3 id="org2ffdd7a"><span class="section-number-3">5.1</span> Analyses univariées</h3>
<div class="outline-text-3" id="text-5-1">
<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li><p>
Faire un <i>boxplot</i> permettant la comparaison des distributions du temps avant défaillance majeure
entre les
composants <code>C01</code> et <code>C02</code>.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> plotly.express <span style="color: #F0DFAF; font-weight: bold;">as</span> px

px.box(data_df, x=<span style="color: #CC9393;">"component"</span>, y=<span style="color: #CC9393;">"ttf"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  title=<span style="color: #CC9393;">"Distribution du temps avant d&#233;faillance majeure pour chaque composant"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  labels=<span style="color: #DCDCCC; font-weight: bold;">dict</span>(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  component=<span style="color: #CC9393;">"Composant"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  ttf=<span style="color: #CC9393;">"Temps avant d&#233;faillance majeure (en heures)"</span>))
</pre>
</div></li>
<li>Faire un <i>boxplot</i> permettant la comparaison des distributions du nombre de sollicitations avant
défaillance majeure entre les
composants <code>C01</code> et <code>C02</code>.</li>
<li>Quel composant semble le plus fiable selon vous ?</li>
</ol>
</div>
</div>

<div id="outline-container-orgf786494" class="outline-3">
<h3 id="orgf786494"><span class="section-number-3">5.2</span> Analyses bivariées</h3>
<div class="outline-text-3" id="text-5-2">
<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li><p>
Faire un <i>boxplot</i> représentant la distribution du temps avant défaillance en
fonction du modèle du distributeur (en abscisse) et du composant (couleur). Observez-vous des différences de fiabilité entre modèles ?
</p>
<div class="org-src-container">
<pre class="src src-python">px.box(data_df, x=<span style="color: #CC9393;">"model"</span>, y=<span style="color: #CC9393;">"ttf"</span>, color=<span style="color: #CC9393;">"component"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  title=<span style="color: #CC9393;">"Distribution du temps avant d&#233;faillance majeure en fonction du mod&#232;le du distributeur"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  labels=<span style="color: #DCDCCC; font-weight: bold;">dict</span>(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  component=<span style="color: #CC9393;">"Composant"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  model=<span style="color: #CC9393;">"Mod&#232;le du distributeur"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  ttf=<span style="color: #CC9393;">"Temps avant d&#233;faillance majeure (en heures)"</span>)
</pre>
</div></li>
<li>Refaire l'analyse précédente en considérant les sollicitations. Les différences de fiabilité
sont-elles analogues dans ce cas ?</li>
<li><p>
Refaire les deux graphiques précédents en considérant à la place du modèle :
</p>
<ul class="org-ul">
<li>le site du distributeur ;</li>
<li>le nombre de maintenances préventives réalisées.</li>
</ul>
<p>
Analysez les résultats.
</p></li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org11c3569" class="outline-2">
<h2 id="org11c3569"><span class="section-number-2">6</span> Définition de la notion de durée</h2>
<div class="outline-text-2" id="text-6">
<p>
D'un point de vue probabiliste, la durée avant un événement d'intérêt est définie par une variable aléatoire \(T\) représentant le temps (ou l'usage) entre un
instant initial (e.g. mise en service d'un appareil, début d'un traitement, dernier achat d'un
client, etc) et la survenue de l'évènement d'intérêt (défaillance d'un appareil, guérison/décès d'un
patient, nouvel achat d'un client). \(T\) est donc une variable aléatoire positive et continue.
</p>

<p>
Selon les applications, la variable \(T\) peut être appelée durée de vie, survie, usage, etc.
L'objectif d'une analyse de durée est alors de caractériser la loi de la variable \(T\) afin d'en
comprendre le comportement et prévoir la survenue des événements futurs.
</p>

<p>
<b>Rappels et remarques</b>
</p>

<ul class="org-ul">
<li>La loi d'une variable aléatoire continue est déterminée par sa fonction de répartition (f.d.r.) \(F\) ou de manière
équivalente par sa densité \(f\).</li>
<li>On rappelle que la f.d.r. \(F\) d'une variable aléatoire de durée est définie pour
\(t \ge 0\), par \(F(t) = P(T \le t)\).</li>
<li>La quantité \(F(t)\) exprime donc la probabilité que l'événement d'intérêt ait lieu avant l'instant \(t\).</li>
</ul>

<p>
<b>Retour sur le cas des distributeurs</b>
</p>

<p>
Si \(T_{1}\) représente la variable aléatoire de durée de vie du composant <code>C01</code>. En posant \(F_{1}\),
la f.d.r. de \(T_{1}\), la quantité \(F_{1}(t)\) exprime alors la probabilité qu'un composant <code>C01</code>
soit touché par une défaillance majeure avant l'instant \(t\). 
</p>
</div>
</div>

<div id="outline-container-org426e1bc" class="outline-2">
<h2 id="org426e1bc"><span class="section-number-2">7</span> Modélisation non paramétrique</h2>
<div class="outline-text-2" id="text-7">
<p>
Dans la suite de ce TD, on désigne par :
</p>
<ul class="org-ul">
<li>\(T_{1}\) et \(T_{2}\), les variables aléatoires du temps avant défaillance majeure des composants
<code>C01</code> et <code>C02</code> respectivement.</li>
<li>\(T^{\prime}_{1}\) et \(T^{\prime}_{2}\), les variables aléatoires du nombre d'opérations avant
défaillance majeure des composants <code>C01</code> et <code>C02</code> respectivement.</li>
</ul>

<p>
<b>Rappel : Fonction de répartition empirique</b>
À partir d'observations de durée \((t_{1}, \ldots, t_{n}\), la fonction de répartition (f.d.r.) empirique de la
loi de durée sous-jacente est donnée par :
\[
\widehat{F}_{n}(t) = \widehat{P}(T \le t) = \frac{1}{n}\sum_{i=1}^{n} \unicode{x1D7D9}_{t_{i} \le t}
\]
</p>
</div>

<div id="outline-container-org1cb3107" class="outline-3">
<h3 id="org1cb3107"><span class="section-number-3">7.1</span> Fonction de répartition empirique (Kaplan-Meier)</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Dans cette section, nous allons modéliser les fonctions de répartition des variables \(T_{1}, T_{2},
T^{\prime}_{1}, T^{\prime}_{2}\) par leur fonction de répartition (f.d.r.) empirique.
</p>

<p>
<b>Travail à réaliser :</b>
</p>

<ol class="org-ol">
<li><p>
Tout d'abord, il faut importer la librairie <code>lifelines</code> (à installer si ce n'est pas déjà le cas) :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> lifelines <span style="color: #F0DFAF; font-weight: bold;">as</span> ll
<span style="color: #F0DFAF; font-weight: bold;">print</span>(ll.version) <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Vous devriez avoir au moins la version 0.26.1</span>
</pre>
</div></li>
<li><p>
Dans les modèles de durée, l'estimateur de la fonction de empirique s'appelle l'estimateur de
Kaplan-Meier. On commence donc par créer un modèle de Kaplan-Meier pour la durée de vie du
composant <code>C01</code> :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">km_c01_ttf</span> = ll.KaplanMeierFitter()
</pre>
</div></li>
<li><p>
Réaliser l'apprentissage du modèle de durée de vie précédent : 
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">idx_c01</span> = data_df[<span style="color: #CC9393;">"component"</span>] == <span style="color: #CC9393;">"C01"</span>
<span style="color: #DFAF8F;">c01_ttf</span> = data_df.loc[idx_c01, <span style="color: #CC9393;">"ttf"</span>]
km_c01_ttf.fit(c01_ttf)
</pre>
</div></li>
<li>Utiliser l'attribut <code>km_c01_ttf.cumulative_density_</code> pour consulter les valeurs de la f.d.r. empirique de la variable \(T_{1}\).
Note: <i>cumulative density</i> signifie fonction de répartition en anglais.</li>
<li><p>
Représenter la f.d.r. empirique de la variable \(T_{1}\) avec <code>plotly</code> :
</p>
<div class="org-src-container">
<pre class="src src-python">px.line(km_c01_ttf.cumulative_density_,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   title=<span style="color: #CC9393;">"Fonction de r&#233;partition empirique de la dur&#233;e de vie du composant C01"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   labels=<span style="color: #DCDCCC; font-weight: bold;">dict</span>(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   value=<span style="color: #CC9393;">"Probabilit&#233;"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   timeline=<span style="color: #CC9393;">"Temps (en heures)"</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   ))
</pre>
</div></li>
<li>Interpréter le résultat de la méthode <code>km_c01_ttf.cumulative_density_at_times(5000)</code>.</li>
<li>Calculer la probabilité qu'une défaillance majeure survienne sur le composant <code>C01</code> entre 10000
et 15000 heures.</li>
<li>Reprendre les questions précédentes en considérant le composant <code>C02</code>.</li>
<li>Représenter les f.d.r. empiriques de la durée de vie des composants <code>C01</code> et <code>C02</code> sur le
même graphique. Interpréter les résultats.</li>
</ol>
</div>
</div>


<div id="outline-container-org34a9868" class="outline-3">
<h3 id="org34a9868"><span class="section-number-3">7.2</span> Fonction de survie/fiabilité</h3>
<div class="outline-text-3" id="text-7-2">
<p>
En considérant une variable de durée \(T\) et sa f.d.r. \(F\), on définit la fonction de survie de \(T\),
notée \(S\) par :
\[
S(t) = 1 - F(t) = P(T > t),~ t \ge 0.
\]
</p>

<p>
La fonction survie est donc une autre façon de caractériser la loi de la variable \(T\). Dans
l'industrie, la fonction de survie est souvent appelée fiabilité, notée \(R\).
</p>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Représenter graphiquement la fonction de survie empirique du composant <code>C01</code>.</li>
<li>Calculer la probabilité que le composant <code>C01</code> fonctionne sans défaillance majeure au moins 1 an en utilisant la méthode <code>km_c01_ttf.survival_function_at_times</code>.</li>
<li>Donner l'expression de la probabilité qu'un composant fonctionne au moins jusqu'à l'instant \(t_{b}\) sachant
qu'il a fonctionné jusqu'à l'instant \(t_{a}\).</li>
<li>Application : Calculer la probabilité que le composant <code>C01</code> fonctionne sans défaillance majeure
au moins 2 ans sachant qu'il a fonctionné 1 an.</li>
</ol>
</div>
</div>

<div id="outline-container-orgcabc59f" class="outline-3">
<h3 id="orgcabc59f"><span class="section-number-3">7.3</span> Taux de risque instantané</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Un autre indicateur couramment utilisé pour caractériser la loi d'une variable de durée \(T\) est le taux de risque
instantané. 
</p>

<p>
Le taux de risque instantané, noté \(h\), est défini par :
\[
h(t) = \lim_{dt \to 0} \frac{P(t \le T < t + dt | T \ge t)}{dt},~ t \ge 0
\]
</p>

<p>
<b>Interprétations :</b>
</p>
<ul class="org-ul">
<li>Cette quantité donne une sorte de score (ce n'est pas une probabilité) que l'événement d'intérêt
survienne tout juste après \(t\) alors que ce dernier n'a pas eu lieu avant \(t\).</li>
<li>Le taux de risque instantané est positif et s'exprime par unité de temps.</li>
</ul>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Montrer que pour tout \(t \ge 0\), \(h(t) = \frac{f(t)}{S(t)}\), où \(f\) est la densité d'une variable
de durée \(T\).</li>
<li><p>
Pour calculer le taux de risque instantané empirique, il faut utiliser l'estimateur de
Nelson-Aalen. Sur le composant <code>C01</code>, cela donne :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">na_c01_ttf</span> = ll.NelsonAalenFitter()
na_c01_ttf.fit(c01_ttf)
</pre>
</div></li>
<li><p>
Représenter graphiquement la taux de risque instantané du composant <code>C01</code> grâce à la méthode
<code>na_c01_ttf.plot_hazard</code> :
</p>
<div class="org-src-container">
<pre class="src src-python">na_c01_ttf.plot_hazard(bandwidth=1)
</pre>
</div></li>
<li>Faire de même pour le composant <code>C02</code> et comparer les résultats.</li>
</ol>

<p>
<b>Remarques :</b>
</p>
<ul class="org-ul">
<li>Le taux de risque instantané ne fournit pas des informations intuitives et directement
interprétables comme la f.d.r. ou la fonction de survie.</li>
<li>Toutefois, cette fonction a des propriétés mathématiques intéressantes et est utilisée pour
construire des modèles de durée plus avancés.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org6b0cea4" class="outline-2">
<h2 id="org6b0cea4"><span class="section-number-2">8</span> Modèle de Cox</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-orgc6494e7" class="outline-3">
<h3 id="orgc6494e7"><span class="section-number-3">8.1</span> Éléments de théorie</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Dans les sections précédentes, nous avons vu comment représenter une loi de durée à partir des
observations des temps d'occurrence de l'événement d'intérêt uniquement. Il s'agissait de modèles
univariés permettant de caractériser la variable de durée \(T\) sans tenir compte de facteurs
explicatifs impactant potentiellement la survenue de l'événement.
</p>

<p>
Afin de palier ces limites, nous introduisons à présent le modèle de Cox. Il s'agit d'un modèle de
régression adapté à l'explication d'une variable de durée à partir de variables explicatives (on
parle également de covariables) qualitatives ou quantitatives binaires. 
</p>

<p>
Le principe du modèle de Cox est de considérer que le logarithme du taux de risque, \(h\), de l'événement
d'intérêt est une fonction linéaire d'une suite de covariables \(X_{1}, \ldots, X_{n}\) et d'un taux
de risque de référence \(h_{0}\) pour l'événement.
</p>

<p>
Cela se traduit par la formulation suivante :
\[
h(t|X_{1},\ldots,X_{n}) = h_{0}(t) \exp\left(\sum_{i=1}^{n} \beta_{i}
X_{i}\right)
\]
où :
</p>
<ul class="org-ul">
<li>le taux de risque de référence \(h_{0}\) dépend du temps mais pas des covariables \(X_{1}, \ldots,
  X_{n}\) ;</li>
<li>on appelle taux de risque relatif la composante \(\exp\left(\sum_{i=1}^{n} \beta_{i} X_{i}\right)\)
qui ne dépend que des covariables et des coefficients de régression \(\beta_{1}, \ldots, \beta_{n}\).</li>
<li>un changement sur les covariables conduit à une modification du taux de risque relatif qui vient
pondérer à la hausse ou à la baisse le taux de risque de référence.</li>
</ul>
</div>
</div>

<div id="outline-container-org5f52b8a" class="outline-3">
<h3 id="org5f52b8a"><span class="section-number-3">8.2</span> Covariable quantitative</h3>
<div class="outline-text-3" id="text-8-2">
<p>
Nous allons construire un premier modèle de Cox permettant d'évaluer la durée de vie des composants
<code>C01</code> et <code>C02</code> en tenant compte des maintenances préventives effectuées entre deux pannes majeures.
</p>

<p>
Nous sommes donc dans le cas où il n'y a qu'une covariable quantitative \(X = \texttt{nb_pm}\).
</p>

<p>
<b>Travail à réaliser</b>
</p>
<ol class="org-ol">
<li>Donner l'expression du taux de risque dans un modèle de Cox à une covariable.</li>
<li><p>
Utiliser la fonction <code>CoxPHFitter</code> afin d'initialiser un modèle de Cox pour le composant <code>CO1</code>
tenant compte de la covariable <code>nb_pm</code> :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">cox_c01_pm_ttf</span> = ll.CoxPHFitter()
cox_c01_pm_ttf.fit(data_df.loc[idx_c01, [<span style="color: #CC9393;">"ttf"</span>, <span style="color: #CC9393;">"nb_pm"</span>]], duration_col=<span style="color: #CC9393;">"ttf"</span>)
</pre>
</div></li>
<li><p>
Utiliser la méthode <code>cox_c01_pm_ttf.print_summary()</code> afin d'afficher un résumé de votre régression.
</p>
<div class="org-src-container">
<pre class="src src-python">cox_c01_pm_ttf.print_summary()
</pre>
</div>
<p>
 Essayez d'interpréter les résultats par analogie avec les autres types de régressions que vous
connaissez.
</p></li>
<li>Que vaut le rapport des risques \(RR(X) = \frac{h(t|X=1)}{h(t|X=0)}\) ? Comment interpréter le
paramètre associé à la covariable \(X\) sur la survenue de l'événement d'intérêt ?</li>
<li><p>
Représenter graphiquement la fonction de survie du composant <code>C01</code> en faisant varier le nombre de
maintenances préventives réalisées :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">nb_pm_val</span> = [0, 1, 2, 3]
<span style="color: #DFAF8F;">cox_c01_pm_ttf_surv_df</span> = cox_c01_pm_ttf.predict_survival_function(pd.DataFrame(<span style="color: #DCDCCC; font-weight: bold;">dict</span>(nb_pm=nb_pm_val)))
<span style="color: #DFAF8F;">cox_c01_pm_ttf_surv_df.columns</span> = [f<span style="color: #CC9393;">"={v}"</span> <span style="color: #F0DFAF; font-weight: bold;">for</span> v <span style="color: #F0DFAF; font-weight: bold;">in</span> nb_pm_val] <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">On renomme les colonnes avec la valeur de la covariable</span>
px.line(cox_c01_pm_ttf_surv_df,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   title=<span style="color: #CC9393;">"Fonction de survie du composant C01 en fonction du nombre de maintenances pr&#233;ventives r&#233;alis&#233;es"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   labels=<span style="color: #DCDCCC; font-weight: bold;">dict</span>(
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   variable=<span style="color: #CC9393;">"nb_pm"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   value=<span style="color: #CC9393;">"probabilit&#233;"</span>, 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   timeline=<span style="color: #CC9393;">"Temps (en heures)"</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   )
</pre>
</div>
<p>
 Ce résultat graphique est-il cohérent par rapport à la valeur du paramètre associé à la variable
<code>nb_pm</code>.
</p></li>
<li>Calculer la durée de vie médiane d'un composant <code>C01</code> ayant eu 0, 1, 2 ou 3 maintenances
préventives selon le modèle. Utiliser la méthode <code>cox_c01_pm_ttf.predict_median(pd.DataFrame(dict(nb_pm=nb_pm_val)))</code>.</li>
<li>Dérouler les questions précédentes avec le composant <code>C02</code>.</li>
<li>Dérouler les questions précédentes en ajoutant une seconde covariable quantitative.</li>
</ol>
</div>
</div>


<div id="outline-container-orge31a4a8" class="outline-3">
<h3 id="orge31a4a8"><span class="section-number-3">8.3</span> Covariable qualitative</h3>
<div class="outline-text-3" id="text-8-3">
<p>
Il s'agit à présent de construire un seconde modèle de Cox permettant cette fois-ci d'évaluer la
durée de vie des composants en tenant compte du site où est installé le distributeur.
</p>

<p>
Nous sommes donc dans le cas où il n'y a qu'une covariable qualitative \(X = \texttt{site}\).
</p>

<p>
Toutefois, cette covariable étant définie sur plusieurs modalités <code>E</code>, <code>S</code>, <code>I</code> et <code>H</code>, il faut,
comme pour la régression logistique, transformer cette variable multimodale en trois variables de <i>design</i> binaires.
</p>

<p>
<b>Travail à réaliser</b>
</p>
<ol class="org-ol">
<li>Donner l'expression du taux de risque dans un modèle de Cox à une covariable qualitative à \(m\)
modalités.</li>
<li><p>
Utiliser la librairie <code>patsy</code> (à installer) pour construire les données contenant les observations de durée de
vie (variable <code>ttf</code>) et les variables de <i>design</i> associées à la variable
<code>site</code> pour le composant <code>C01</code> :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> patsy

<span style="color: #DFAF8F;">data_dsite_ttf_df</span> = patsy.dmatrix(<span style="color: #CC9393;">"ttf + site"</span>, 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> data_df.loc[idx_c01, [<span style="color: #CC9393;">"ttf"</span>, <span style="color: #CC9393;">"site"</span>]], 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> return_type=<span style="color: #CC9393;">"dataframe"</span>).drop(<span style="color: #CC9393;">"Intercept"</span>, axis=1)
</pre>
</div></li>
<li>Créer un modèle pour le composant <code>CO1</code> tenant compte des covariables de <i>design</i> associées à la
variable <code>site</code>. Interprétez les résultats de la régression et en particulier la valeur des
 coefficients.</li>
<li>Représenter graphiquement la fonction de survie du composant <code>C01</code> en fonction du site du
distributeur.</li>
<li>Calculer la durée de vie médiane d'un composant <code>C01</code> sur les différents sites.</li>
<li>Dérouler les questions précédentes avec le composant <code>C02</code>.</li>
</ol>
</div>
</div>
</div>
</div>
</body>
</html>
